FROM nginx

COPY ./server/mini_web_server.c /mini_web_server/
COPY ./server/4.sh /mini_web_server/
COPY ./server/nginx/nginx.conf /etc/nginx/nginx.conf

RUN apt-get update ; \
    apt-get install -y gcc  \
    make \
    spawn-fcgi \
    libfcgi-dev ; \
    /etc/init.d/nginx start ; \
    useradd -d /home/ldormamm -m -s /bin/bash ldormamm ; \
    chown -R ldormamm:ldormamm /mini_web_server && chmod -R 755 /mini_web_server ; \
    chown -R ldormamm:ldormamm /var/cache/ldormamm ; \
    chown -R ldormamm:ldormamm /var/log/ldormamm ; \
    chown -R ldormamm:ldormamm /etc/nginx/conf.d ; \
    touch /var/run/nginx.pid ; \
    chown -R ldormamm:ldormamm /var/run/nginx.pid ; \
    chmod u-s usr/bin/gpasswd ; \
    chmod u-s bin/mount ; \
    chmod u-s bin/su ; \
    chmod g-s usr/bin/chage ; \
    chmod u-s usr/bin/chsh ; \
    chmod u-s usr/bin/newgrp ; \
    chmod u-s usr/bin/passwd ; \
    chmod g-s usr/bin/wall ; \
    chmod u-s usr/bin/chfn ; \
    chmod g-s sbin/unix_chkpwd ; \
    chmod u-s bin/umount ; \
    chmod g-s usr/bin/expiry ; \
    rm -rf /var/lib/apt/lists
    
USER ldormamm

WORKDIR /mini_web_server/

ENTRYPOINT [ "./4.sh" ]

HEALTHCHECK --interval=5s --timeout=10s --retries=3 CMD curl --silent --fail localhost:81/